{% extends 'main_app/base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}
  {{ page_title }}
{% endblock page_title %}

{% block content %}
<style>
    .card-header {
        background-color: #000000;
        color: white;
    }
    .form-group label {
        font-weight: bold;
    }
    .form-check-label {
        font-weight: normal;
    }
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }
    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }
    .status-green {
        background-color: #d4edda;
    }
    .status-red {
        background-color: #f8d7da;
    }
    .status-yellow {
        background-color: #fff3cd;
    }
</style>
<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header">
            <h3 class="card-title mb-0">{% trans 'Upload Excel File' %}</h3>
        </div>
        <div class="card-body">
            <p>{% trans 'Please choose an Excel file to upload and select the data model.' %}</p>
            <form id="upload-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="modelSelect">{% trans 'Select Model:' %}</label>
                    <select class="form-control" id="modelSelect" name="model" required>
                        <option value="">{% trans 'Select Table Type' %}</option>
                        <option value="CustomUser">{% trans 'CustomUser' %}</option>
                        <option value="Session">{% trans 'Session' %}</option>
                        <option value="Campus">{% trans 'Campus' %}</option>
                        <option value="Course">{% trans 'Course' %}</option>
                        <option value="ClassSchedule">{% trans 'ClassSchedule' %}</option>
                        <option value="LearningRecord">{% trans 'LearningRecord' %}</option>
                        <option value="PaymentRecord">{% trans 'PaymentRecord' %}</option>
                        <option value="RefundRecord">{% trans 'RefundRecord' %}</option>
                        <option value="Mixed">{% trans 'Mixed' %}</option>
                    </select>
                </div>
                <div class="form-group" id="user-type-group" style="display: none;">
                    <label>{% trans 'Select User Type:' %}</label>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" id="userTypeTeacher" name="user_type" value="Teacher">
                        <label class="form-check-label" for="userTypeTeacher">{% trans 'Teacher' %}</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" id="userTypeStudent" name="user_type" value="Student">
                        <label class="form-check-label" for="userTypeStudent">{% trans 'Student' %}</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="excelFile">{% trans 'Excel File:' %}</label>
                    <input type="file" class="form-control-file" id="excelFile" name="excel_file" required>
                </div>
                <button type="submit" class="btn btn-primary mt-3">{% trans 'Upload' %}</button>
            </form>

            <!-- Placeholder for displaying column status -->
            <div id="column-status" class="mt-4"></div>
        </div>
    </div>
</div>
{% endblock content %}
{% block custom_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

document.getElementById('modelSelect').addEventListener('change', function() {
    var userTypeGroup = document.getElementById('user-type-group');
    if (this.value === 'CustomUser') {
        userTypeGroup.style.display = 'block';
    } else {
        userTypeGroup.style.display = 'none';
    }
});

document.getElementById('excelFile').addEventListener('change', function() {
    var file = this.files[0];
    if (!file) {
        return;
    }

    var formData = new FormData();
    formData.append('excel_file', file);
    formData.append('model', document.getElementById('modelSelect').value);
    
    var userTypeRadios = document.getElementsByName('user_type');
    var userType = null;
    for (var i = 0; i < userTypeRadios.length; i++) {
        if (userTypeRadios[i].checked) {
            userType = userTypeRadios[i].value;
            break;
        }
    }
    if (userType) {
        formData.append('user_type', userType);
    }

    fetch("{% url 'check_columns' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrftoken
        }
    }).then(response => response.json())
      .then(data => {
          var columnStatusDiv = document.getElementById('column-status');
          columnStatusDiv.innerHTML = '';
          if (data.success) {
              for (var model in data.columns) {
                  if (document.getElementById('modelSelect').value === 'Mixed' || document.getElementById('modelSelect').value === model || (document.getElementById('modelSelect').value === 'CustomUser' && (model === 'CustomUser' || model === userType))) {
                      var statusTable = '<h5>' + model + '</h5>';
                      statusTable += '<table class="table table-bordered">';
                      statusTable += '<thead><tr><th>{% trans "Column Name" %}</th><th>{% trans "Status" %}</th><th>{% trans "Autofill" %}</th></tr></thead>';
                      statusTable += '<tbody>';
                      data.columns[model].forEach(col => {
                          var statusClass = col.status === 'exists' ? 'status-green' : (col.status === 'missing' ? 'status-red' : 'status-yellow');
                          var autofill = col.status === 'autofill' ? `<button class="btn btn-link" onclick="confirmAutofill('${col.name}', '${col.autofill_from}')">{% trans "Confirm" %}</button>` : '';
                          statusTable += `<tr class="${statusClass}"><td>${col.name}</td><td>${col.status === 'exists' ? '{% trans "Exists" %}' : (col.status === 'missing' ? '{% trans "Missing" %}' : '{% trans "Autofill" %}')}</td><td>${autofill}</td></tr>`;
                      });
                      statusTable += '</tbody></table>';
                      columnStatusDiv.innerHTML += statusTable;
                  }
              }
          } else {
              columnStatusDiv.innerHTML = '<p class="text-danger">{% trans "Error processing the file." %}</p>';
          }
      }).catch(error => {
          document.getElementById('column-status').innerHTML = '<p class="text-danger">{% trans "Error uploading the file." %}</p>';
      });
});

function confirmAutofill(column, autofillFrom) {
    alert(`Autofill confirmed for ${column} using ${autofillFrom}`);
    // Handle autofill confirmation logic here
}

document.getElementById('upload-form').addEventListener('submit', function(event) {
    var modelSelect = document.getElementById('modelSelect');
    if (modelSelect.value === '') {
        alert("{% trans 'Please select a table type.' %}");
        event.preventDefault();
        return;
    }
});

</script>
{% endblock custom_js %}
