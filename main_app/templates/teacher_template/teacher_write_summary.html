{% extends 'main_app/base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}
    {{ page_title }}
{% endblock page_title %}

{% block content %}
<style>
    .responsive-buttons {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
    }

    .btn-responsive {
        flex: 1 1 auto;
        margin: 5px;
        min-width: 68px;
        text-align: center;
    }

    @media (max-width: 576px) {
        .btn-responsive {
            flex-basis: 100%;
        }
    }

    .table-container {
        overflow-x: auto;
    }

    th, td {
        white-space: nowrap;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }
    .pagination a, .pagination span {
        margin: 0 5px;
        padding: 8px 16px;
        text-decoration: none;
        color: #5FC032;
        border: 1px solid #DEE2E600;
        border-radius: 4px;
    }
    .pagination a:hover {
        background-color: #e9ecef;
    }
    .pagination .current {
        background-color: #5FC032;
        color: white;
    }
     /* Custom style for close (x) icon */
     .modal-header .close {
        font-size: 30px; /* Adjust the size as needed */
        position: absolute; /* Positions the close (x) icon absolutely */
        right: 20px; /* Adjust the distance from the right side */
        top: 5; /* Aligns the close (x) icon with the top of the modal header */
    }
</style>
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <!-- general form elements -->
                <div class="card card-dark">
                    <div class="card-header">
                        <h3 class="card-title">{{ page_title }}</h3>
                    </div>

                    {% include "main_app/form_template.html" with messages=messages form=form button_text="Submit Summary" %}
                </div>
                <!-- /.card -->
                <div class="card card-dark">
                    <div class="card-header"><h3 class="card-title">Summaries</h3></div>
                    <div class="table-container p-2">
                        <table class="table table-bordered">
                            <tr>
                                <th>ID</th>
                                <th>{% trans 'Student' %}</th>
                                <th>{% trans 'Summary' %}</th>
                                <th>{% trans 'Sent On' %}</th>
                                <th>{% trans 'Status' %}</th>
                                <th>{% trans 'Replied Date' %}</th>
                                <th>{% trans 'Reply' %}</th>
                                <th>{% trans 'Action' %}</th>
                            </tr>
                            {% for summary in summaries %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ summary.student.admin.full_name }}</td>
                                <td>{{ summary.summary }}</td>
                                <td>{{ summary.created_at|date:"Y-m-d H:i:s" }}</td>
                                {% if summary.reply == "" %}
                                    <td><span class='badge badge-warning'>{% trans 'pending' %}</span></td>
                                    <td><span class='badge badge-warning'>{% trans 'pending' %}</span></td>
                                    <td><button data-toggle="modal" data-target="#reply_modal" value="{{ summary.id }}" class="btn btn-success reply_open_modal">{% trans 'Reply' %}</button></td>
                                {% else %}
                                    <td><span class='badge badge-success'>{% trans 'seen' %}</span></td>
                                    <td>{{ summary.replied_at }}</td>
                                    <td>{{ summary.reply }}</td>
                                {% endif %}
                                <td class="responsive-buttons">
                                    <a href="#" class="btn btn-info btn-responsive edit_button" data-id="{{ summary.id }}" data-summary="{{ summary.summary }}">{% trans 'Edit' %}</a>
                                    <button class="btn btn-danger btn-responsive delete_button" data-id="{{ summary.id }}">{% trans 'Delete' %}</button>
                                </td>         
                            </tr>
                            {% endfor %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Edit Modal -->
<div class="modal fade" id="edit_modal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="editModalLabel">
                    {% trans 'Edit Summary' %}
                </h4>
            </div>            
            <div class="modal-body">
                <input type="hidden" id="edit_id">
                <p>{% trans 'Edit summary for' %} <span id="edit_summary_name"></span></p>  
                <textarea name="edit_summary_message" id="edit_summary_message" cols="30" rows="10" class="form-control"></textarea>
            </div>
            <div class="modal-footer">
                <button id="edit_btn" class="btn btn-success btn-block">{% trans 'Edit' %}</button>
                <button type="button" class="btn btn-danger btn-block" data-dismiss="modal">{% trans 'Cancel' %}</button>          
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block custom_js %}
<script>
    $(document).ready(function(){
        function openEditModal() {
            $(".edit_button").click(function() {
                var id = $(this).data("id");
                var summary = $(this).data("summary");
                var name = $(this).parents("tr").children("td:eq(1)").text();
                $("#edit_summary_name").text(name);
                $("#edit_id").val(id);
                $("#edit_summary_message").val(summary);
                $("#edit_modal").modal("show");
            });
        }

        function updateSummary() {
            $("#edit_btn").on("click", function() {
                var id = $("#edit_id").val();
                var summary = $("#edit_summary_message").val();

                $.ajax({
                    url: "{% url 'teacher_write_summary' %}",
                    type: 'POST',
                    data: {
                        id: id,
                        summary: summary,
                        edit: true
                    }
                }).done(function(response) {
                    if (response == "True") {
                        alert("{% trans 'Summary Updated' %}");
                        location.reload();
                    } else {
                        alert("{% trans 'Summary Could Not Be Updated' %}");
                    }
                }).fail(function() {
                    alert("{% trans 'Error Occurred.' %}");
                });
            });
        }

        function deleteSummary() {
            $(".delete_button").click(function() {
                var id = $(this).data("id");
                if (confirm("{% trans 'Are you sure you want to delete this summary?' %}")) {
                    $.ajax({
                        url: "{% url 'delete_summary' %}",
                        type: 'POST',
                        data: {
                            id: id
                        }
                    }).done(function(response) {
                        if (response == "True") {
                            alert("{% trans 'Summary deleted successfully' %}");
                            location.reload();
                        } else {
                            alert("{% trans 'Failed to delete summary' %}");
                        }
                    }).fail(function() {
                        alert("{% trans 'Error occurred while deleting summary' %}");
                    });
                }
            });
        }

        // Initialize functions
        openEditModal();
        updateSummary();
        deleteSummary();
    });
</script>
{% endblock custom_js %}
