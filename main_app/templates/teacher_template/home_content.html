{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}
{% block content %}
<section class="content">
  <div class="container-fluid">
    <!-- Small boxes (Stat box) -->
    <div class="row">
        <div class="col-lg-3 col-6">
            <div class="small-box bg-teal">
                <div class="inner">
                    <h3>{{total_students}}</h3>
                    <p>Total Students</p>
                </div>
                <div class="icon">
                  <i class="nav-icon fas fa-user-graduate"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
                <div class="inner">
                    <h3>{{total_attendance}}</h3>
                    <p>Total Attendance Taken</p>
                </div>
                <div class="icon">
                  <i class="nav-icon fas fa-calendar-alt"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
            <div class="small-box bg-blue">
                <div class="inner">
                    <h3>{{total_leave}}</h3>
                    <p>Total Leave Applications</p>
                </div>
                <div class="icon">
                  <i class="nav-icon fas fa-sign-out-alt"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-6">
          <div class="small-box bg-pink">
              <div class="inner">
                  <h3>{{total_courses}}</h3>
                  <p>Total Teaching Courses</p>
              </div>
              <div class="icon">
                <i class="nav-icon fas fa-book"></i>
              </div>
          </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-4">
            <select id="course-filter" class="form-control">
                <option value="">Select Course</option>
                {% for course in courses %}
                    <option value="{{ course.id }}">{{ course.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <select id="class-schedule-filter" class="form-control">
                <option value="">Select Class Schedule</option>
                {% for schedule in class_schedules %}
                    <option value="{{ schedule.id }}">{{ schedule.start_time }} to {{ schedule.end_time }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <select id="student-filter" class="form-control">
                <option value="">Select Student</option>
                {% for student in students %}
                    <option value="{{ student.id }}">{{ student.admin.full_name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card card-secondary">
                <div class="card-header">
                    <h3 class="card-title">Attendance Statistics</h3>
                    <div class="card-tools">
                      <button type="button" class="btn btn-tool" data-card-widget="collapse"><i class="fas fa-minus"></i>
                      </button>
                      <button type="button" class="btn btn-tool" data-card-widget="remove"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart">
                        <canvas id="attendanceChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
  </div>
</section>
{% endblock content %}

{% block custom_js %}
<script>
  $(document).ready(function(){
    function updateChart(data) {
        console.log("Updating chart with data:", data); // Debugging log
        
        if (data.labels.length === 0 || data.attendance_counts.length === 0) {
            console.warn("No data available to display on the chart."); // Warning log
            return;
        }

        var ctx = $('#attendanceChart').get(0).getContext('2d');
        var chartData = {
            labels: data.labels,
            datasets: [{
                label: 'Attendance Count',
                backgroundColor: '#17A2B8',
                borderColor: 'rgba(60,141,188,0.8)',
                data: data.attendance_counts
            }]
        };
        var chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
        };

        if (window.attendanceChart instanceof Chart) {
            window.attendanceChart.destroy();
        }

        window.attendanceChart = new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: chartOptions
        });
    }

    function fetchAttendanceData() {
        var course = $('#course-filter').val();
        var class_schedule = $('#class-schedule-filter').val();
        var student = $('#student-filter').val();
        console.log("Fetching attendance data for course:", course, "class schedule:", class_schedule, "student:", student); // Debugging log
        $.ajax({
            url: "{% url 'teacher_home' %}",
            data: {
                course: course,
                class_schedule: class_schedule,
                student: student
            },
            success: function(response) {
                console.log("AJAX response data:", response); // Debugging log
                updateChart(response.data);
            },
            error: function(xhr, status, error) {
                console.error("AJAX request failed:", status, error); // Debugging log
            }
        });
    }

    function fetchClassSchedules(course_id) {
        console.log("Fetching class schedules for course:", course_id); // Debugging log
        $.ajax({
            url: "{% url 'get_class_schedules' %}",
            data: {
                course_id: course_id
            },
            success: function(response) {
                console.log("Class schedules:", response); // Debugging log
                var scheduleSelect = $('#class-schedule-filter');
                scheduleSelect.empty();
                scheduleSelect.append('<option value="">Select Class Schedule</option>');
                $.each(response, function(index, schedule) {
                    scheduleSelect.append('<option value="'+schedule.id+'">'+schedule.start_time+' to '+schedule.end_time+'</option>');
                });
            },
            error: function(xhr, status, error) {
                console.error("Failed to fetch class schedules:", status, error); // Debugging log
            }
        });
    }

    $('#course-filter').change(function(){
        var course_id = $(this).val();
        fetchClassSchedules(course_id);
        fetchAttendanceData();
    });

    $('#class-schedule-filter').change(function(){
        fetchAttendanceData();
    });

    $('#student-filter').change(function(){
        fetchAttendanceData();
    });

    // Initial load
    fetchAttendanceData();
});

</script>
{% endblock custom_js %}
