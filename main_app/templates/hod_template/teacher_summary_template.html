{% extends 'main_app/base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}
  {{ page_title }}
{% endblock page_title %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div id="success-message" class="alert alert-success" style="display: none;"></div>
        <div class="row">
            <div class="col-md-12">
                <div class="card card-dark">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="d-flex align-items-center">
                            <i class="nav-icon fas fa-comment-alt" style="font-size: 24px; margin-right: 10px;"></i>
                            <h3 class="card-title">{% trans page_title %}</h3>
                        </div>
                    </div>
                    <div class="table-container card-body">
                        <table class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>{% trans 'Teacher' %}</th>
                                    <th>{% trans 'Student' %}</th>
                                    <th>{% trans 'Summary' %}</th>
                                    <th>{% trans 'Sent On' %}</th>
                                    <th>{% trans 'Status' %}</th>
                                    <th>{% trans 'Reply' %}</th>
                                    <th>{% trans 'Replied Date' %}</th>
                                    <th>{% trans 'Action' %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for summary in summaries %}
                                <tr id="summary-{{ summary.id }}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ summary.teacher }}</td>
                                    <td>{{ summary.student.admin.full_name }}</td>
                                    <td>{{ summary.summary }}</td>
                                    <td>{{ summary.created_at }}</td>
                                    {% if not summary.reply %}
                                        <td><span class='badge badge-warning'>{% trans 'Pending Response' %}</span></td>
                                        <td><button data-toggle="modal" data-target="#reply_modal" value="{{ summary.id }}" class="btn btn-success reply_open_modal">{% trans 'Reply' %}</button></td>
                                        <td><span class='badge badge-warning'>{% trans 'Pending Response' %}</span></td>
                                    {% else %}
                                        <td><span class='badge badge-success'>{% trans 'Response Sent' %}</span></td>
                                        <td>{{ summary.reply }}</td>
                                        <td>{{ summary.replied_at }}</td>
                                    {% endif %}
                                    <td class="responsive-buttons">
                                        <a href="#" class="btn btn-info btn-responsive edit_button" data-id="{{ summary.id }}" data-reply="{{ summary.reply }}">{% trans 'Edit' %}</a>
                                        <button class="btn btn-danger btn-responsive delete_button" data-id="{{ summary.id }}">{% trans 'Delete' %}</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Reply Modal -->
<div class="modal fade" id="reply_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">{% trans 'Reply To Summary' %}</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="id">
                <p>{% trans 'Reply to' %} <span id="reply_name"></span></p>
                <textarea name="reply_message" id="reply_message" cols="30" rows="10" class="form-control"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">{% trans 'Close' %}</button>
                <button id="reply_btn" class="btn btn-success btn-block">{% trans 'Reply' %}</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="edit_modal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="editModalLabel">{% trans 'Edit Reply' %}</h4>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_id">
                <p>{% trans 'Edit reply for' %} <span id="edit_reply_name"></span></p>
                <textarea name="edit_reply_message" id="edit_reply_message" cols="30" rows="10" class="form-control"></textarea>
            </div>
            <div class="modal-footer">
                <div class="button-group">
                    <button id="edit_btn" class="btn btn-success">{% trans 'Edit' %}</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">{% trans 'Cancel' %}</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block custom_css %}
<style>
    .responsive-buttons {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
    }

    .btn-responsive {
        flex: 1 1 auto;
        margin: 5px;
        min-width: 68px;
        text-align: center;
    }

    @media (max-width: 576px) {
        .btn-responsive {
            flex-basis: 100%;
        }
    }

    .table-container {
        overflow-x: auto;
    }

    th, td {
        white-space: nowrap;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin: 20px 0;
    }

    .pagination a, .pagination span {
        margin: 0 5px;
        padding: 8px 16px;
        text-decoration: none;
        color: #5FC032;
        border: 1px solid #DEE2E600;
        border-radius: 4px;
    }

    .pagination a:hover {
        background-color: #e9ecef;
    }

    .pagination .current {
        background-color: #5FC032;
        color: white;
    }

    /* Custom style for close (x) icon */
    .modal-header .close {
        font-size: 30px; /* Adjust the size as needed */
        position: absolute; /* Positions the close (x) icon absolutely */
        right: 20px; /* Adjust the distance from the right side */
        top: 5px; /* Aligns the close (x) icon with the top of the modal header */
    }

    /* Styles for modal footer buttons */
    .modal-footer .button-group {
        display: flex;
        flex-direction: column;
        width: 100%;
    }

    .modal-footer .button-group .btn {
        width: 100%;
        margin-bottom: 5px;
    }

    .modal-footer .button-group .btn:last-child {
        margin-bottom: 0;
    }
</style>
{% endblock custom_css %}

{% block custom_js %}
<script>
    $(document).ready(function(){
        function openReplyModal() {
            $(".reply_open_modal").click(function() {
                var id = $(this).val();
                var name = $(this).parents("tr").children("td:eq(1)").text();
                $("#reply_name").text(name);
                $("#id").val(id);
            });
        }

        function openEditModal() {
            $(".edit_button").click(function() {
                var id = $(this).data("id");
                var reply = $(this).data("reply");
                var name = $(this).parents("tr").children("td:eq(1)").text();
                $("#edit_reply_name").text(name);
                $("#edit_id").val(id);
                $("#edit_reply_message").val(reply);
                $("#edit_modal").modal("show");
            });
        }

        function sendReply() {
            $("#reply_btn").on("click", function() {
                var id = $("#id").val();
                var reply = $("#reply_message").val();

                $.ajax({
                    url: "{% url 'view_teacher_summary' %}",
                    type: 'POST',
                    data: {
                        id: id,
                        reply: reply
                    }
                }).done(function(response) {
                    if (response == "True") {
                        alert("{% trans 'Reply Sent' %}");
                        location.reload();
                    } else {
                        alert("{% trans 'Reply Could Not Be Sent' %}");
                    }
                }).fail(function() {
                    alert("{% trans 'Error Occurred.' %}");
                });
            });
        }

        function updateReply() {
            $("#edit_btn").on("click", function() {
                var id = $("#edit_id").val();
                var reply = $("#edit_reply_message").val();

                $.ajax({
                    url: "{% url 'view_teacher_summary' %}",
                    type: 'POST',
                    data: {
                        id: id,
                        reply: reply,
                        edit: true
                    }
                }).done(function(response) {
                    if (response == "True") {
                        alert("{% trans 'Reply Updated' %}");
                        location.reload();
                    } else {
                        alert("{% trans 'Reply Could Not Be Updated' %}");
                    }
                }).fail(function() {
                    alert("{% trans 'Error Occurred.' %}");
                });
            });
        }

        function deleteSummary() {
            $(".delete_button").click(function() {
                var id = $(this).data("id");
                if (confirm("{% trans 'Are you sure you want to delete this summary?' %}")) {
                    $.ajax({
                        url: "{% url 'delete_teacher_summary' %}",
                        type: 'POST',
                        data: {
                            id: id
                        }
                    }).done(function(response) {
                        if (response.success) {
                            $("#success-message").text(response.message).show();
                            $("#summary-" + id).remove();
                        } else {
                            alert(response.message);
                        }
                    }).fail(function() {
                        alert("{% trans 'Error occurred while deleting summary.' %}");
                    });
                }
            });
        }

        // Initialize functions
        openReplyModal();
        openEditModal();
        sendReply();
        updateReply();
        deleteSummary();
    });
</script>
{% endblock custom_js %}
