{% extends 'main_app/base.html' %}
{% load static %}
{% load i18n %}
{% block page_title %}{% trans page_title %}{% endblock page_title %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <!-- general form elements -->
                <div class="card card-dark">
                    <div class="card-header">
                        <h3 class="card-title">{% trans page_title %}</h3>
                    </div>
                    {% include "main_app/form_template.html" with messages=messages form=form button_text=_("Update Schedule") %}
                </div>
                <!-- /.card -->
            </div>
        </div>
    </div>
</section>

<script src="{% static 'dist/js/jquery.min.js' %}"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("#id_course").change(function() {
            var courseId = $(this).val();
            console.log("Selected course ID:", courseId);
            populate_teachers(courseId);
        });

        $("#id_teacher").change(function() {
            var courseId = $("#id_course").val();
            var teacherId = $(this).val();
            console.log("Selected teacher ID:", teacherId);
            update_class_schedule(courseId, teacherId);
        });
    });

    function populate_teachers(courseId) {
        $.ajax({
            url: "/get_filtered_teachers/",
            type: "GET",
            data: { course_id: courseId },
            success: function(response) {
                console.log("Response:", response);
                var teacherDropdown = $("#id_teacher");
                teacherDropdown.empty();
                teacherDropdown.append('<option value="">---------</option>');
                if (response.teachers) {
                    console.log("Teachers:", response.teachers);
                    $.each(response.teachers, function(index, teacher) {
                        teacherDropdown.append('<option value="' + teacher.id + '">' + teacher.name + '</option>');
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error("AJAX request failed with status:", status);
                console.error("Error:", error);
                console.error("Response:", xhr.responseText);
            },
            complete: function(xhr, status) {
                console.log("AJAX request completed with status:", status);
            }
        });
    }

    function update_class_schedule(courseId, teacherId) {
    $.ajax({
        url: "/get_class_schedule/",
        type: "GET",
        data: {
            course_id: courseId,
            teacher_id: teacherId
        },
        success: function(response) {
            console.log("Class Schedule Response:", response);
            if (response.schedule) {
                console.log("Day:", response.schedule.day);
                console.log("Start Time:", response.schedule.start_time);
                console.log("End Time:", response.schedule.end_time);
                $("#id_day").val(response.schedule.day_name); // Use day name instead of number
                $("#id_start_time").val(response.schedule.start_time);
                $("#id_end_time").val(response.schedule.end_time);
                $("#id_lesson_hours").val(response.schedule.lesson_hours);
            } else {
                console.log("No schedule found for the selected course and teacher.");
                $("#id_day").val("");
                $("#id_start_time").val("");
                $("#id_end_time").val("");
                $("#id_lesson_hours").val("");
            }
        },
        error: function(xhr, status, error) {
            console.error("AJAX request failed with status:", status);
            console.error("Error:", error);
            console.error("Response:", xhr.responseText);
        },
        complete: function(xhr, status) {
            console.log("AJAX request completed with status:", status);
        }
    });
}
</script>

{% endblock content %}
